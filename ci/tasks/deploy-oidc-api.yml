platform: linux
image_resource:
  type: registry-image
  source:
    repository: hashicorp/terraform
    tag: 1.0.4
    username: ((docker-hub-username))
    password: ((docker-hub-password))
params:
  DEPLOYER_ROLE_ARN: ((deployer-role-arn-non-prod))
  DEPLOY_ENVIRONMENT: build
  NOTIFY_API_KEY: ((build-notify-api-key))
  DNS_DEPLOYER_ROLE_ARN: ((deployer-role-arn-production))
  DNS_STATE_BUCKET: ((dns-state-bucket))
  DNS_STATE_KEY: ((dns-state-key))
inputs:
  - name: api-src
  - name: oidc-api-release
  - name: frontend-api-release
  - name: client-registry-api-release
  - name: lambda-warmer-release
  - name: shared-terraform-outputs
outputs:
  - name: terraform-outputs
run:
  path: /bin/sh
  args:
    - -euc
    - |
      cd "api-src/ci/terraform/oidc"
      terraform init -input=false \
        -backend-config "role_arn=${DEPLOYER_ROLE_ARN}" \
        -backend-config "bucket=digital-identity-dev-tfstate" \
        -backend-config "key=${DEPLOY_ENVIRONMENT}-terraform.tfstate" \
        -backend-config "encrypt=true" \
        -backend-config "region=eu-west-2"

      terraform apply -auto-approve \
        -var 'oidc_api_lambda_zip_file=../../../../oidc-api-release/oidc-api.zip' \
        -var 'frontend_api_lambda_zip_file=../../../../frontend-api-release/frontend-api.zip' \
        -var 'client_registry_api_lambda_zip_file=../../../../client-registry-api-release/client-registry-api.zip' \
        -var 'lambda_warmer_zip_file=../../../../lambda-warmer-release/lambda-warmer.zip' \
        -var "deployer_role_arn=${DEPLOYER_ROLE_ARN}" \
        -var "notify_api_key=${NOTIFY_API_KEY}" \
        -var "environment=${DEPLOY_ENVIRONMENT}" \
        -var 'logging_endpoint_enabled=true' \
        -var 'logging_endpoint_arn=arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod' \
        -var "dns_state_bucket=${DNS_STATE_BUCKET}" \
        -var "dns_state_key=${DNS_STATE_KEY}" \
        -var "dns_state_role=${DNS_DEPLOYER_ROLE_ARN}" \
        -var "external_redis_host=$(jq -r .redis_host.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "external_redis_port=$(jq -r .redis_port.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "external_redis_password=$(jq -r .redis_password.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "authentication_security_group_id=$(jq -r .authentication_security_group_id.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "authentication_subnet_ids=$(jq -r .authentication_subnet_ids.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "lambda_iam_role_arn=$(jq -r .lambda_iam_role_arn.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "lambda_iam_role_name=$(jq -r .lambda_iam_role_name.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "dynamo_sqs_lambda_iam_role_arn=$(jq -r .dynamo_sqs_lambda_iam_role_arn.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "dynamo_sqs_lambda_iam_role_name=$(jq -r .dynamo_sqs_lambda_iam_role_name.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "sqs_lambda_iam_role_arn=$(jq -r .sqs_lambda_iam_role_arn.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "sqs_lambda_iam_role_name=$(jq -r .sqs_lambda_iam_role_name.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "email_lambda_iam_role_arn=$(jq -r .email_lambda_iam_role_arn.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "token_lambda_iam_role_arn=$(jq -r .token_lambda_iam_role_arn.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \
        -var "id_token_signing_key_alias_name=$(jq -r .id_token_signing_key_alias_name.value < shared-terraform-outputs/terraform-outputs/${DEPLOY_ENVIRONMENT}-shared-terraform-outputs.json)" \

      terraform output --json > ../../../../terraform-outputs/${DEPLOY_ENVIRONMENT}-terraform-outputs.json
